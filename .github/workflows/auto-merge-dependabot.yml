name: Auto-merge Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: write

jobs:
  auto-merge:
    name: Auto-merge Dependabot
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Check if PR is ready
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Check if all checks have passed
            const checks = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const allPassed = checks.data.check_runs.every(
              check => check.conclusion === 'success' || check.conclusion === null
            );
            
            return allPassed;

      - name: Auto-merge patch and minor updates
        if: steps.check.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title.toLowerCase();
            
            // Only auto-merge patch and minor updates
            if (title.includes('bump') && (title.includes('patch') || title.includes('minor'))) {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash'
              });
              
              console.log('✅ Auto-merged Dependabot PR');
            } else {
              console.log('⏭️  Skipping auto-merge (major version or other change)');
            }
