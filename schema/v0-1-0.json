{
  "$defs": {
    "Condition": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "field": {
          "type": "string",
          "minLength": 1
        },
        "field_path": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Optional path for nested field access (e.g., ['address', 'city'])"
        },
        "op": {
          "oneOf": [
            {
              "enum": [
                "eq", "ne", "in", "notIn", "isNull",
                "gt", "gte", "lt", "lte", "between",
                "contains", "startsWith", "endsWith",
                "like", "ilike", "regex",
                "has", "hasSome", "hasEvery", "jsonContains",
                "lenEq", "lenGt", "lenLt", "exists"
              ]
            },
            {
              "type": "string",
              "pattern": "^custom:.+$"
            }
          ]
        },
        "value": {},
        "path": {
          "type": "array",
          "items": { "type": "string" },
          "deprecated": true,
          "description": "Deprecated: use field_path instead"
        }
      },
      "required": ["field", "op"]
    },
    "Filter": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "and": {
          "type": "array",
          "items": { "$ref": "#/$defs/Filter" }
        },
        "or": {
          "type": "array",
          "items": { "$ref": "#/$defs/Filter" }
        },
        "not": { "$ref": "#/$defs/Filter" },
        "conditions": {
          "type": "array",
          "items": { "$ref": "#/$defs/Condition" }
        }
      }
    },
    "OrderBy": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "field": {
          "type": "string",
          "minLength": 1
        },
        "descending": {
          "type": "boolean"
        },
        "nulls_first": {
          "type": "boolean"
        },
        "case_sensitive": {
          "type": "boolean"
        }
      },
      "required": ["field"]
    },
    "Query": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "model": {
          "type": "string",
          "minLength": 1
        },
        "fields": {
          "type": "array",
          "items": { "type": "string" }
        },
        "where": { "$ref": "#/$defs/Filter" },
        "order_by": {
          "type": "array",
          "items": { "$ref": "#/$defs/OrderBy" }
        },
        "limit": { "type": "integer" },
        "offset": { "type": "integer" },
        "distinct": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "required": ["model"]
    },
    "Include": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "query": { "$ref": "#/$defs/Query" },
        "kind": {
          "enum": ["some", "every", "none"]
        },
        "includes": {
          "type": "array",
          "items": { "$ref": "#/$defs/Include" }
        }
      }
    },
    "Pagination": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "first": {
          "type": "integer",
          "minimum": 1
        },
        "last": {
          "type": "integer",
          "minimum": 1
        },
        "after": { "type": "string" },
        "before": { "type": "string" }
      }
    },
    "Statement": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "query": { "$ref": "#/$defs/Query" },
        "pagination": { "$ref": "#/$defs/Pagination" },
        "group_by": {
          "type": "array",
          "items": { "type": "string" }
        },
        "having": { "$ref": "#/$defs/Filter" },
        "includes": {
          "type": "array",
          "items": { "$ref": "#/$defs/Include" }
        },
        "orm_version": {
          "type": "string",
          "description": "Diagnostic only; excluded from canonicalization"
        },
        "sdk_version": {
          "type": "string",
          "description": "Diagnostic only; excluded from canonicalization"
        }
      }
    },
    "KV": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "field": {
          "type": "string",
          "minLength": 1
        },
        "value": {}
      },
      "required": ["field", "value"]
    },
    "Change": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "model": {
          "type": "string",
          "minLength": 1
        },
        "action": {
          "enum": ["insert", "update", "delete"]
        },
        "sets": {
          "type": "array",
          "items": { "$ref": "#/$defs/KV" }
        },
        "where": { "$ref": "#/$defs/Filter" }
      },
      "required": ["model", "action"]
    },
    "Mutation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "tx_id": { "type": "string" },
        "changes": {
          "type": "array",
          "items": { "$ref": "#/$defs/Change" }
        }
      },
      "required": ["changes"]
    },
    "PaginationBoundary": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "order_by": {
          "type": "array",
          "items": { "$ref": "#/$defs/OrderBy" }
        },
        "row": {
          "type": "object",
          "additionalProperties": {},
          "description": "Field values of the last included row"
        },
        "cursor": { "$ref": "#/$defs/KV" }
      },
      "required": ["order_by", "row"]
    },
    "Dependencies": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "shape_id": {
          "type": "string",
          "pattern": "^s_[0-9a-f]{64}$"
        },
        "records": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": { "type": "string" }
          }
        },
        "filters": {
          "type": "array",
          "items": { "$ref": "#/$defs/Filter" }
        },
        "includes": {
          "type": "array",
          "items": { "$ref": "#/$defs/Include" }
        },
        "last_row": { "$ref": "#/$defs/PaginationBoundary" },
        "group_by": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "keys": {
              "type": "array",
              "items": { "type": "string" }
            },
            "values": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": {}
              }
            }
          },
          "required": ["keys", "values"]
        }
      },
      "required": ["shape_id", "records", "filters", "includes"]
    }
  },
  "$id": "https://github.com/bold-minds/includekit-spec/schema/v0-1-0.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "IncludeKit Universal Format v0.1",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "Statement": { "$ref": "#/$defs/Statement" },
    "Mutation": { "$ref": "#/$defs/Mutation" },
    "Dependencies": { "$ref": "#/$defs/Dependencies" }
  }
}
